---
title: "Read and Compute Gages"
format: html
editor: visual
---

Quarto markdown to read in gages from CAMELS data set, compute hydrologic signatures.

## Read in Libraries:

```{r, echo=FALSE}
#install.packages("data.table")

library(tidyverse)
library(ggforce)
library(ggplot2)
library(gridExtra)
library(lubridate)
library(dplyr)
library(readr)
library(data.table)
library(leaflet)


#USGS package with flow info
library(dataRetrieval)

#Packages working with geospatial data
library(sf)
library(tmap)
library(tmaptools)
library(mapview)

```

## Read in gauges from CAMELS dataset:

'camels_hydro' is the dataset using CAMELS gauges and computing signatures:

-   flow mean (q_mean), runoff ratio, slope flow duration (slope_fdc), baseflow index, steam elasticity, q5, q95, high flow freq, low flow freq, zero flow freq,

```         
```

```{r}
## Read in gauges from CAMELS dataset:

#'camels_hydro' is the dataset using CAMELS gauges and computing signatures:

#flow mean (q_mean), runoff ratio, slope flow duration (slope_fdc), baseflow index, steam elasticity, q5, q95, high flow freq, low flow freq, zero flow freq,

camels_hydro <- read_delim("CAMELS Data/camels_hydro.txt")

#All other CAMELS data
camels_all <- full_join(read_delim("CAMELS Data/camels_clim.txt"),
                                     read_delim("CAMELS Data/camels_geol.txt"), by = "gauge_id") |>
  full_join(read_delim("CAMELS Data/camels_hydro.txt"), by = "gauge_id") |>
  full_join(read_delim("CAMELS Data/camels_soil.txt"), by = "gauge_id") |>
  full_join(read_delim("CAMELS Data/camels_topo.txt"), by = "gauge_id") |>
  full_join(read_delim("CAMELS Data/camels_vege.txt"), by = "gauge_id") |> 
  full_join(read_delim("CAMELS Data/camels_name.txt"), by = "gauge_id")

#View Camels hydrology:
head(camels_hydro)

```

## RBI and Mean Annual Discharge

```{r}

#Read in CONUS daily flow gages
q_data  <-  read.csv("C:/Users/Logan/Desktop/College/Coursework/Junior Year/Research Project/data/CAMELS_qdv.csv")

# Turn gauge id column from number to character
q_data$gauge_id <- as.character(q_data$gauge_id)

# Add zero to gauge id ONLY IF the length is < 8
q_data$gauge_id <- ifelse(nchar(q_data$gauge_id) < 8, paste0("0", q_data$gauge_id), q_data$gauge_id)

#Group by gauge id, lag flow by one day
RBI <-  q_data %>% 
  group_by(gauge_id) %>% 
  mutate(discharge_change = Qmm_day - lag(Qmm_day, default = first(Qmm_day)),
         abs_discharge_change = abs(discharge_change)) %>% 
summarize(RBI = sum(abs_discharge_change, na.rm = TRUE)/sum(Qmm_day)) 

RBI$gauge_id <- as.character(RBI$gauge_id)

RBI$gauge_id <- ifelse(nchar(RBI$gauge_id) < 8, paste0("0", RBI$gauge_id), RBI$gauge_id)

# Check data for NA's
find_NA_lines <- function(data, column_name) {
  na_lines <- which(is.na(data[[column_name]]))
  return(na_lines)
}

NA_lines <- find_NA_lines(RBI, "RBI")

### Mean Annual Discharge


mean_annual_discharge = q_data %>%
  group_by(gauge_id) %>%
summarize(Qmean_mm_yr = mean(Qmm_day))


#Join data to camels_hydro data
camels_all <- left_join(camels_all, RBI, by = "gauge_id")
camels_all <- left_join(camels_all,mean_annual_discharge, by = "gauge_id")

write.csv(camels_all,"C:\\Users\\Logan\\Desktop\\College\\Coursework\\Junior Year\\Second Semester\\Analysis in GIS\\ESDA\\ESDA\\camels_all.csv")

#Write out dataframe with RBI and gauge ID
#computed_metrics = left_join(RBI, mean_annual_discharge, by = "gauge_id")
#write_csv(computed_metrics, "CAMELS Data/computed_metrics.csv")

#Write out joined file (camels_hydro + camels_rbi)
#write_csv(camels_all, "CAMELS Data/camels_all.csv")

```

## Combining USGS Data with CAMELS:

```{r}
##### reading in USGS with CAMELS 

USGS = st_read("C:\\Users\\Logan\\Desktop\\College\\Coursework\\Junior Year\\Research Project\\data\\Gages_physio shp")

USGS_select = select(USGS, SOURCE_FEA, SOURCE_ORI, FEATUREDET, Measure, EventType, FLComID, AREA, PERIMETER, PHYSIODD_, PHYSIODD_I, FCODE, FENCODE, DIVISION, PROVINCE, SECTION, PROVCODE, geometry)

camels_joined = right_join(USGS_select, camels_all, by=c('SOURCE_FEA'='gauge_id'))

#### case_when()

camels_joined = mutate(camels_joined, CONUS = case_when(
  DIVISION == "APPALACHIAN HIGHLANDS" ~ "APPS", TRUE ~ "CONUS"))

head(camels_joined)
  
app_gauges = filter(camels_joined, DIVISION == "APPALACHIAN HIGHLANDS")
app_gauges_CONUS = app_gauges
app_gauges_CONUS$CONUS[app_gauges_CONUS$CONUS == "APPS"] <- "CONUS"
##View(app_gauges_CONUS)

camels_final = rbindlist(list(camels_joined,app_gauges_CONUS))

#write.csv(camels_final,"C:\\Users\\Logan\\Desktop\\College\\Coursework\\Junior Year\\Second Semester\\Analysis in GIS\\ESDA\\ESDA\\camels_final.csv")


```

```{r}

```

## Creating Study Area Map

sf_use_s2(TRUE)

```{r}

App_regions = st_read("Data/Shapefiles/AppalachianRegions.shp")
#GagesII = st_read("Data/Shapefiles/gagesII_9322_sept30_2011.shp")
physio_regions = st_read("Data/Shapefiles/physio.shp")
watersheds = st_read("Mapping Data/small_ws")
states = st_read("Mapping Data/cb_2018_us_state_20m")

####select mean annual discharge, mean winter discharge, mean summer discharge, high flow (90%), low flow (10%), BFI, runoff ratio, and RBI

#app_states = select(filter(states, NAME=="Florida","Georgia","Alabama","South Carolina","North Carolina","Tennessee","Kentucky","West Virgina","Virginia","Maryland","Delaware","Ohio","Pennsylvania","New Jersey","New York","Massachusetts","Rhode Island","Conneticut","New Hampshire","Vermont","Maine","District of Columbia"))

###mapping

mapview(camels_joined)

mapview(app_gauges)

camels_mapping = st_sf(camels_final)

#### tmap
theme_set(theme_classic())

tmap_mode("plot")

tmap_options(check.and.fix = TRUE)


tm_shape(camels_mapping)+
  tm_dots(col="blue")+
  tm_shape(states)+
  tm_borders()+
  tm_compass(type="4star",position=c("right","bottom"))+
  tm_scale_bar(position=c("left","bottom"))+
  tm_layout(title="CAMELS Gauges", title.position=c("right","TOP"))
  
tm_shape(watersheds)+
  tm_fill("lightblue")+
  tm_borders()+
  tm_shape(states)+
  tm_borders()+
  tm_compass(type="4star",position=c("right","bottom"))+
  tm_scale_bar(position=c("left","bottom"))+
  tm_layout(title="CAMELS Watersheds", title.position=c("right","TOP"))

tm_shape(App_regions)+
  tm_fill()+
  tm_borders()+
  tm_shape(states)+
  tm_borders()+
  tm_shape(filter(camels_mapping, CONUS == "APPS"))+
  tm_dots(col="blue")+
  tm_compass(type="4star",position=c("right","bottom"))+
  tm_scale_bar(position=c("left","bottom"))+
  tm_layout(title="Appalachian Gauges", title.position=c("center","TOP"))
  
tm_shape(App_regions)+
  tm_fill(col="PROVINCE")+
  tm_borders()+
  tm_shape(app_gauges)+
  tm_dots(col="blue")+
  tm_shape(states)+
  tm_borders()+
  tm_compass(type="4star",position=c("right","bottom"))+
  tm_scale_bar(position=c("left","bottom"))+
  tm_layout(title="Appalachian Gauges", title.position=c("center","TOP"))
  tm_layout(legend.position=c("left","center"))
  
watersheds <- watersheds %>%
  mutate(GAGE_ID = paste0("0", hru_id))

##sf_use_s2(TRUE)
##watersheds_apps <- left_join(app_gauges,watersheds, by=c("GAGE_ID"="SOURCE_FEA"))
  
  tm_shape(watersheds)+
    tm_fill("lightblue")+
    tm_borders()+
    tm_shape(states)+
    tm_borders()+
    tm_compass(type="4star",position=c("right","bottom"))+
    tm_scale_bar(position=c("left","bottom"))+
    tm_layout(title="CAMELS Watersheds", title.position=c("right","TOP"))


```

Creating Boxplots

```{r}
#### boxplots
#### use ggplot instead of boxplot

###Basic Statistics

#summary(camels_joined$baseflow_index)
#summary(app_gauges$baseflow_index)

#####ESDA Spatial Analysis Class Boxplots
#########select mean annual discharge, mean winter discharge, mean summer discharge, high flow (90%), low flow (10%), BFI, runoff ratio, and RBI

par(mfcol=c(1,4))

boxplot(camels_final$baseflow_index~camels_final$CONUS,xlab="Region",ylab="BFI")

boxplot(camels_final$runoff_ratio~camels_final$CONUS,xlab="Region",ylab="Runoff Ratio")

boxplot(camels_final$q5~camels_final$CONUS,xlab="Region",ylab="Low Flow (5%)")

boxplot(camels_final$q95~camels_final$CONUS,xlab="Region",ylab="High Flow (95%)")

par(mfcol=c(1,4))

boxplot(camels_final$q_mean~camels_final$CONUS,xlab="Region",ylab="Mean Daily Discharge")

boxplot(camels_final$RBI~camels_final$CONUS,xlab="Region",ylab="RBI")

## ggplot boxplots

##example
##camels_final |> 
  #ggplot(aes(CONUS,baseflow_index))+
  #geom_boxplot()

par(mfcol=c(1,1))

baseflow <- ggplot(data=camels_final,aes(x=CONUS,y=baseflow_index))+
  geom_boxplot()+
  coord_flip()+
  ##ggtitle()+
  xlab("Region")+
  ylab("BFI")+
  geom_boxplot(fill="grey")+
  theme(
  axis.ticks = element_line(color = "black", size = 0.5),
  panel.grid.major = element_line(color = "black", linetype = "dashed", size = 0.25),
  panel.grid.minor = element_line(color = "black", linetype = "dashed", size = 0.25)
  )

runoff_ratio <- ggplot(data=camels_final,aes(x=CONUS,y=runoff_ratio))+
  geom_boxplot()+
  coord_flip()+
  ##ggtitle()+
  xlab("Region")+
  ylab("Runoff Ratio")+
  geom_boxplot(fill="grey")+
  theme(
  axis.ticks = element_line(color = "black", size = 0.5),
  panel.grid.major = element_line(color = "black", linetype = "dashed", size = 0.25),
  panel.grid.minor = element_line(color = "black", linetype = "dashed", size = 0.25)
  )

q5 <- ggplot(data=camels_final,aes(x=CONUS,y=q5))+
  geom_boxplot()+
  coord_flip()+
  ##ggtitle()+
  xlab("Region")+
  ylab("Low Flow (5%)")+
  geom_boxplot(fill="grey")+
  theme(
  axis.ticks = element_line(color = "black", size = 0.5),
  panel.grid.major = element_line(color = "black", linetype = "dashed", size = 0.25),
  panel.grid.minor = element_line(color = "black", linetype = "dashed", size = 0.25)
  )

q95 <- ggplot(data=camels_final,aes(x=CONUS,y=q95))+
  geom_boxplot()+
  coord_flip()+
  ##ggtitle()+
  xlab("Region")+
  ylab("High Flow (95%)")+
  geom_boxplot(fill="grey")+
  theme(
  axis.ticks = element_line(color = "black", size = 0.5),
  panel.grid.major = element_line(color = "black", linetype = "dashed", size = 0.25),
  panel.grid.minor = element_line(color = "black", linetype = "dashed", size = 0.25)
  )

q_mean <- ggplot(data=camels_final,aes(x=CONUS,y=q_mean))+
  geom_boxplot()+
  coord_flip()+
  xlab("Region")+
  ylab("Mean Daily Discharge")+
  geom_boxplot(fill="grey")+
  theme(
  axis.ticks = element_line(color = "black", size = 0.5),
  panel.grid.major = element_line(color = "black", linetype = "dashed", size = 0.25),
  panel.grid.minor = element_line(color = "black", linetype = "dashed", size = 0.25)
  )

RBI <- ggplot(data=camels_final,aes(x=CONUS,y=RBI))+
  geom_boxplot()+
  coord_flip()+
  xlab("Region")+
  ylab("RBI")+
  geom_boxplot(fill="grey")+
  theme(
  axis.ticks = element_line(color = "black", size = 0.5),
  panel.grid.major = element_line(color = "black", linetype = "dashed", size = 0.25),
  panel.grid.minor = element_line(color = "black", linetype = "dashed", size = 0.25)
  )

#start a pdf file
pdf("four_plots.pdf")

#arrange the plots on the pdf Page

grid.arrange(baseflow,runoff_ratio,q5,q95,nrow=4)

dev.off()

pdf("two_plots.pdf")

grid.arrange(q_mean, RBI,nrow=2)

dev.off()
  

### aes sets x and y variables
### make new column in CAMELS with new variable Appregions "yes" or "no"
### use mutate and case_when to create new columb with logic statement

```

Distribution Curves and Statistical Tests

```{r}
####histograms

#### density functions

plot(density(camels_joined$baseflow_index))
plot(density(app_gauges$baseflow_index))

plot(density(camels_density$runoff_ratio, na.rm = TRUE))
plot(density(app_gauges$runoff_ratio, na.rm = TRUE))

plot(density(camels_joined$q5, na.rm = TRUE))
plot(density(app_gauges$q5, na.rm = TRUE))

plot(density(camels_joined$q95, na.rm = TRUE))
plot(density(app_gauges$q95, na.rm = TRUE))
```
